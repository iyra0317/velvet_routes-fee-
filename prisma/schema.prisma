// Velvet Routes - MySQL Database Schema
// Generated for travel booking platform with hotels, flights, cars, trains, buses
// Supports Stripe payments, PDF invoices, Twilio notifications, and external APIs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  ADMIN
  MANAGER
}

enum TravelMode {
  HOTEL
  FLIGHT
  CAR
  TRAIN
  BUS
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentStatus {
  INIT
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  RAZORPAY
}

enum NotificationChannel {
  PUSH
  SMS
  WHATSAPP
  EMAIL
}

enum NotificationStatus {
  SENT
  FAILED
  DELIVERED
  READ
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(uuid()) @db.VarChar(36)
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  name          String    @db.VarChar(255)
  phone         String?   @db.VarChar(20)
  isVerified    Boolean   @default(false) @map("is_verified")
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLogin     DateTime? @map("last_login")
  metadata      Json?     // Additional user preferences, settings

  // Relations
  profile       Profile?
  bookings      Booking[]
  payments      Payment[]
  reviews       Review[]
  notifications Notification[]
  sessions      Session[]
  searches      Search[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([lastLogin])
  @@map("users")
}

model Profile {
  id              String   @id @default(uuid()) @db.VarChar(36)
  userId          String   @unique @map("user_id") @db.VarChar(36)
  dob             DateTime? @db.Date
  address         String?   @db.Text
  passportNumber  String?   @map("passport_number") @db.VarChar(50)
  preferences     Json?     // Travel preferences, dietary restrictions, etc.
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ============================================================================
// EXTERNAL PROVIDERS & API KEYS
// ============================================================================

model Provider {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(255)
  baseUrl     String?  @map("base_url") @db.VarChar(500)
  isActive    Boolean  @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  apiKeys        ProviderApiKey[]
  inventoryItems InventoryItem[]

  @@map("providers")
}

model ProviderApiKey {
  id           String   @id @default(uuid()) @db.VarChar(36)
  providerId   String   @map("provider_id") @db.VarChar(36)
  envName      String   @map("env_name") @db.VarChar(100)
  keyReference String   @map("key_reference") @db.VarChar(255)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, envName])
  @@map("provider_api_keys")
}

// ============================================================================
// INVENTORY / PRODUCTS
// ============================================================================

model InventoryItem {
  id                 String     @id @default(uuid()) @db.VarChar(36)
  providerId         String     @map("provider_id") @db.VarChar(36)
  providerItemId     String     @map("provider_item_id") @db.VarChar(255)
  travelMode         TravelMode @map("travel_mode")
  rawData            Json       @map("raw_data")
  priceCents         Int        @map("price_cents")
  currency           String     @default("USD") @db.VarChar(3)
  searchableLocation String?    @map("searchable_location") @db.VarChar(255)
  availableFrom      DateTime?  @map("available_from")
  availableTo        DateTime?  @map("available_to")
  isAvailable        Boolean    @default(true) @map("is_available")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  provider     Provider      @relation(fields: [providerId], references: [id])
  bookingItems BookingItem[]
  reviews      Review[]

  // Specialized relations
  hotel  Hotel?
  flight Flight?
  car    Car?
  train  Train?
  bus    Bus?

  @@index([travelMode])
  @@index([searchableLocation])
  @@index([isAvailable])
  @@index([providerId, providerItemId])
  @@map("inventory_items")
}

model Hotel {
  id              String   @id @default(uuid()) @db.VarChar(36)
  inventoryItemId String   @unique @map("inventory_item_id") @db.VarChar(36)
  name            String   @db.VarChar(500)
  location        String   @db.VarChar(500)
  address         String?  @db.Text
  rating          Float?
  stars           Int?     @db.SmallInt
  amenities       Json?
  checkInTime     String?  @map("check_in_time") @db.VarChar(10)
  checkOutTime    String?  @map("check_out_time") @db.VarChar(10)
  imageUrl        String?  @map("image_url") @db.Text

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([location])
  @@index([rating])
  @@map("hotels")
}

model Flight {
  id              String   @id @default(uuid()) @db.VarChar(36)
  inventoryItemId String   @unique @map("inventory_item_id") @db.VarChar(36)
  airline         String   @db.VarChar(255)
  flightNumber    String   @map("flight_number") @db.VarChar(20)
  origin          String   @db.VarChar(255)
  originCode      String   @map("origin_code") @db.VarChar(10)
  destination     String   @db.VarChar(255)
  destinationCode String   @map("destination_code") @db.VarChar(10)
  departAt        DateTime @map("depart_at")
  arriveAt        DateTime @map("arrive_at")
  duration        Int      // Minutes
  stops           Int      @default(0) @db.SmallInt
  aircraftType    String?  @map("aircraft_type") @db.VarChar(100)
  cabinClass      String?  @map("cabin_class") @db.VarChar(50)

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([origin, destination])
  @@index([departAt])
  @@map("flights")
}

model Car {
  id              String   @id @default(uuid()) @db.VarChar(36)
  inventoryItemId String   @unique @map("inventory_item_id") @db.VarChar(36)
  name            String   @db.VarChar(255)
  category        String   @db.VarChar(100)
  supplier        String   @db.VarChar(255)
  location        String   @db.VarChar(500)
  seats           Int      @db.SmallInt
  doors           Int      @db.SmallInt
  transmission    String   @db.VarChar(50)
  fuelType        String?  @map("fuel_type") @db.VarChar(50)
  features        Json?
  imageUrl        String?  @map("image_url") @db.Text

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([location])
  @@index([category])
  @@map("cars")
}

model Train {
  id              String   @id @default(uuid()) @db.VarChar(36)
  inventoryItemId String   @unique @map("inventory_item_id") @db.VarChar(36)
  operator        String   @db.VarChar(255)
  trainNumber     String   @map("train_number") @db.VarChar(50)
  origin          String   @db.VarChar(255)
  destination     String   @db.VarChar(255)
  departAt        DateTime @map("depart_at")
  arriveAt        DateTime @map("arrive_at")
  duration        Int      // Minutes
  trainClass      String?  @map("train_class") @db.VarChar(50)
  amenities       Json?

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([origin, destination])
  @@map("trains")
}

model Bus {
  id              String   @id @default(uuid()) @db.VarChar(36)
  inventoryItemId String   @unique @map("inventory_item_id") @db.VarChar(36)
  operator        String   @db.VarChar(255)
  busNumber       String   @map("bus_number") @db.VarChar(50)
  origin          String   @db.VarChar(255)
  destination     String   @db.VarChar(255)
  departAt        DateTime @map("depart_at")
  arriveAt        DateTime @map("arrive_at")
  duration        Int      // Minutes
  busType         String?  @map("bus_type") @db.VarChar(50)
  amenities       Json?

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([origin, destination])
  @@map("buses")
}

// ============================================================================
// BOOKINGS
// ============================================================================

model Booking {
  id              String        @id @default(uuid()) @db.VarChar(36)
  userId          String        @map("user_id") @db.VarChar(36)
  totalAmountCents Int          @map("total_amount_cents")
  currency        String        @default("USD") @db.VarChar(3)
  status          BookingStatus @default(PENDING)
  customerName    String        @map("customer_name") @db.VarChar(255)
  customerEmail   String        @map("customer_email") @db.VarChar(255)
  customerPhone   String?       @map("customer_phone") @db.VarChar(20)
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  bookingItems BookingItem[]
  payments     Payment[]
  invoices     Invoice[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("bookings")
}

model BookingItem {
  id              String     @id @default(uuid()) @db.VarChar(36)
  bookingId       String     @map("booking_id") @db.VarChar(36)
  inventoryItemId String?    @map("inventory_item_id") @db.VarChar(36)
  providerItemId  String     @map("provider_item_id") @db.VarChar(255)
  travelMode      TravelMode @map("travel_mode")
  quantity        Int        @default(1) @db.SmallInt
  unitPriceCents  Int        @map("unit_price_cents")
  startDate       DateTime?  @map("start_date")
  endDate         DateTime?  @map("end_date")
  seatInfo        Json?      @map("seat_info")
  meta            Json?      // Additional booking details
  createdAt       DateTime   @default(now()) @map("created_at")

  booking       Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)

  @@index([bookingId])
  @@index([inventoryItemId])
  @@map("booking_items")
}

// ============================================================================
// PAYMENTS & INVOICES
// ============================================================================

model Payment {
  id                String          @id @default(uuid()) @db.VarChar(36)
  bookingId         String          @map("booking_id") @db.VarChar(36)
  userId            String          @map("user_id") @db.VarChar(36)
  provider          PaymentProvider @default(STRIPE)
  stripePaymentId   String?         @unique @map("stripe_payment_id") @db.VarChar(255)
  amountCents       Int             @map("amount_cents")
  currency          String          @default("USD") @db.VarChar(3)
  status            PaymentStatus   @default(INIT)
  refundedAt        DateTime?       @map("refunded_at")
  metadata          Json?
  createdAt         DateTime        @default(now()) @map("created_at")

  booking Booking  @relation(fields: [bookingId], references: [id], onDelete: Restrict)
  user    User     @relation(fields: [userId], references: [id], onDelete: Restrict)
  refunds Refund[]

  @@index([bookingId])
  @@index([userId])
  @@index([stripePaymentId])
  @@index([status])
  @@map("payments")
}

model Invoice {
  id             String   @id @default(uuid()) @db.VarChar(36)
  bookingId      String   @map("booking_id") @db.VarChar(36)
  invoicePdfUrl  String?  @map("invoice_pdf_url") @db.Text
  totalCents     Int      @map("total_cents")
  currency       String   @default("USD") @db.VarChar(3)
  generatedAt    DateTime @default(now()) @map("generated_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("invoices")
}

model Refund {
  id          String        @id @default(uuid()) @db.VarChar(36)
  paymentId   String        @map("payment_id") @db.VarChar(36)
  amountCents Int           @map("amount_cents")
  status      PaymentStatus @default(INIT)
  providerRef String?       @map("provider_ref") @db.VarChar(255)
  reason      String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Restrict)

  @@index([paymentId])
  @@map("refunds")
}

// ============================================================================
// REVIEWS
// ============================================================================

model Review {
  id              String   @id @default(uuid()) @db.VarChar(36)
  userId          String   @map("user_id") @db.VarChar(36)
  inventoryItemId String   @map("inventory_item_id") @db.VarChar(36)
  rating          Int      @db.SmallInt // 1-5
  title           String?  @db.VarChar(255)
  body            String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([inventoryItemId])
  @@index([rating])
  @@map("reviews")
}

// ============================================================================
// NOTIFICATIONS & LOGS
// ============================================================================

model Notification {
  id                 String             @id @default(uuid()) @db.VarChar(36)
  userId             String             @map("user_id") @db.VarChar(36)
  channel            NotificationChannel
  email              String?            @db.VarChar(255)
  phone              String?            @db.VarChar(20)
  message            String             @db.Text
  providerMessageId  String?            @map("provider_message_id") @db.VarChar(255)
  status             NotificationStatus @default(SENT)
  metadata           Json?
  createdAt          DateTime           @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.VarChar(36)
  userId     String?  @map("user_id") @db.VarChar(36)
  action     String   @db.VarChar(100)
  objectType String   @map("object_type") @db.VarChar(100)
  objectId   String?  @map("object_id") @db.VarChar(36)
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([objectType, objectId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// SEARCH HISTORY & CACHING
// ============================================================================

model Search {
  id               String    @id @default(uuid()) @db.VarChar(36)
  userId           String?   @map("user_id") @db.VarChar(36)
  query            Json
  resultsSnapshot  Json?     @map("results_snapshot")
  resultCount      Int?      @map("result_count")
  createdAt        DateTime  @default(now()) @map("created_at")
  expiresAt        DateTime? @map("expires_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("searches")
}

// ============================================================================
// SESSIONS & AUTH
// ============================================================================

model Session {
  id               String    @id @default(uuid()) @db.VarChar(36)
  userId           String    @map("user_id") @db.VarChar(36)
  refreshTokenHash String    @map("refresh_token_hash") @db.VarChar(255)
  ipAddress        String?   @map("ip_address") @db.VarChar(45)
  userAgent        String?   @map("user_agent") @db.Text
  expiresAt        DateTime  @map("expires_at")
  revoked          Boolean   @default(false)
  createdAt        DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([revoked])
  @@map("sessions")
}
